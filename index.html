<!DOCTYPE HTML>
<html>

<head>
    <title>Skillbot Analysis</title>
    <meta charset="UTF-8">
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        .content {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #030303;
            height: 10vh;
        }

        .value {
            font-size: 50px;
            display: block;
            font-weight: bold;
            color: #fff;
        }
    </style>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.25.1/moment.min.js"></script>

    <script>
        var chart = null;
        // var dataPoints1 = [];
        var totalUsers = 0;

        window.onload = async function () {
                

            // console.log(moment().format('LTS'));
                //Total Undefined Messages
                var utc = new Date().toJSON().slice(0,10).replace(/-/g,'-');
                
                console.log(utc);
               
                var totalUsers = 0;
                await fetch('https://mongo-analytics-api.herokuapp.com/analytics/total-conv-count/default/default', {
                    method: 'GET', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Credentials' : true,
                        'Access-Control-Allow-Headers': true
                    }
                })
                .then(response => response.json())  // convert to json
                .then(json =>{
                    
                        totalUsers += json.conversation_count;
                        // console.log(totalUndefinedMsg);

                })    //print data to console
                .catch(err => console.log('Request Failed', err)); // Catch errors
                
                console.log(totalUsers);

                
                var totalUndefinedMsg = 0;
                var totalSuccessMsg = 0;
                await fetch('https://mongo-analytics-api.herokuapp.com/analytics/total-messages-summary-count/default/default', {
                    method: 'GET', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Credentials' : true,
                        'Access-Control-Allow-Headers': true
                    }
                })
                .then(response => response.json())  // convert to json
                .then(json =>{
                    
                        totalUndefinedMsg += json.unidentified_message_count;
                        totalSuccessMsg += json.identified_message_count;
                        // console.log(totalUndefinedMsg);

                })    //print data to console
                .catch(err => console.log('Request Failed', err)); // Catch errors
                
            //Sentiment Analysis

                var neutral=0;
                var pos=0;
                var neg=0;
                await fetch('https://mongo-analytics-api.herokuapp.com/analytics/sentiment-counts', {
                    method: 'GET', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Credentials' : true,
                        'Access-Control-Allow-Headers': true
                    }
                })
                .then(response => response.json())  // convert to json
                .then(value =>{
                    pos = value.happy_user;
                    neg = value.unhappy_user;
                    neutral = value.neutral_user;
                })    //print data to console
                .catch(err => console.log('Request Failed', err)); // Catch errors

                //Popular Intent

                var intents;
                await fetch('https://mongo-analytics-api.herokuapp.com/analytics/overall-popular-intents/default/default', {
                    method: 'GET', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Credentials' : true,
                        'Access-Control-Allow-Headers': true
                    }
                })
                .then(response => response.json())  // convert to json
                .then(value =>{
                    intents = value.popular_intents;
                    // console.log(neutral);
                })    //print data to console
                .catch(err => console.log('Request Failed', err)); // Catch errors

                var date = new Date();
                var firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                var lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                var datapoints2=[];
                await fetch('https://mongo-analytics-api.herokuapp.com/analytics/interval-conv-count/default/default/default', {
                    method: 'GET', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Credentials' : true,
                        'Access-Control-Allow-Headers': true
                    }
                })
                .then(response => response.json())  // convert to json
                .then(value =>{
                    for (var i = 0; i < value.length; i++) {
                        // console.log(value[i]);
                        
                        datapoints2.push({
                            x: new Date(value[i].final_date),
                            y: value[i].conversation_count
                        });
                    }
                    chartVisitor.render();
                    // console.log(neutral);
                })    //print data to console
                .catch(err => console.log('Request Failed', err)); // Catch errors

                
                // var today = d.getFullYear+"-"+d 

                var datapoints1=[];
                await fetch(`https://mongo-analytics-api.herokuapp.com/analytics/interval-conv-count/2021-05-01/${utc}/monthly`, {
                    method: 'GET', // or 'PUT'
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Credentials' : true,
                        'Access-Control-Allow-Headers': true
                    }
                })
                .then(response => response.json())  // convert to json
                .then(value =>{
                    for (var i = 0; i < value.length; i++) {
                        let val = moment(new Date(value[i].final_date)).format("MMM,YYYY");
                        datapoints1.push({
                            x: new Date(value[i].initial_date),
                            y: value[i].conversation_count
                        });
                    }
                    
                    // console.log(neutral);
                })    //print data to console
                .catch(err => console.log('Request Failed', err)); // Catch errors

                //Daily User vs Unique Users of the bot
            var chartVisitor = new CanvasJS.Chart("visitor", {
                animationEnabled: true,
                theme: "light2",
                title: {
                    text: "Chabot Users Information"
                },
                axisX: {
                    valueFormatString: "DD MMM",
                    crosshair: {
                        enabled: true,
                        snapToDataPoint: true
                    }
                },
                axisY: {
                    title: "Number of Visits",
                    crosshair: {
                        enabled: true
                    }
                },
                toolTip: {
                    shared: true
                },
                legend: {
                    cursor: "pointer",
                    verticalAlign: "bottom",
                    horizontalAlign: "left",
                    dockInsidePlotArea: true,
                    itemclick: toogleDataSeries
                },
                data: [{
                    type: "line",
                    showInLegend: true,
                    name: "Total Visit",
                    markerType: "square",
                    xValueFormatString: "DD MMM, YYYY",
                    color: "#F08080",
                    dataPoints: datapoints2
                }]
            });
            chartVisitor.render();

            function toogleDataSeries(e) {
                if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                chartVisitor.render();
            }



            //Daily Visitor using api of the bot
            var chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                theme: "light2",
                title: {
                    text: "Monthly Chatbot Data By using API"
                },
                axisY: {
                    title: "Users",
                    titleFontSize: 24
                },
                data: [{
                    type: "column",
                    yValueFormatString: "#,### Users",
                    dataPoints: datapoints1
                }]
            });
            chart.render();

            // $.getJSON("https://canvasjs.com/data/gallery/javascript/daily-sales.json?callback=?", callback);


            //Success Rate of the bot
            var successChart = new CanvasJS.Chart("chartSuccess", {
                animationEnabled: true,
                title: {
                    text: "Success Rate of the bot",
                    horizontalAlign: "left"
                },
                data: [{
                    type: "pie",
                    startAngle: 60,
                    //innerRadius: 60,
                    indexLabelFontSize: 17,
                    indexLabel: "{label} - #percent%",
                    toolTipContent: "<b>{label}:</b> {y} (#percent%)",
                    dataPoints: [
                        { y: totalSuccessMsg, label: "Successful Message" },
                        { y: totalUndefinedMsg, label: "Unidentified Message" }
                    ]
                }]
            });
            successChart.render();

            $(document).ready(function () {
                $('#example').DataTable({
                    responsive: true
                });
            });
            


            //Sentiment Analysis of the bot
            var sentimentChart = new CanvasJS.Chart("sentimentChart", {
                animationEnabled: true,
                title: {
                    text: "Sentiment Analysis of the bot",
                    horizontalAlign: "left"
                },
                data: [{
                    type: "pie",
                    startAngle: 60,
                    //innerRadius: 60,
                    indexLabelFontSize: 17,
                    indexLabel: "{label} - #percent%",
                    toolTipContent: "<b>{label}:</b> {y} (#percent%)",
                    dataPoints: [
                        { y: neutral, label: "Neutral Message" },
                        { y: pos, label: "Positive Message" },
                        { y: neg, label: "Negative Message" }
                    ]
                }]
            });
            sentimentChart.render();


            var myTable = document.getElementById("insertHere");
            for (var i in intents){
                var elm = document.createElement('tr');
                inputStr=`<td>${intents[i].intent}</td><td>${intents[i].occurence}</td>`;
                var i=0;
                var j=0;
                while (i<inputStr.lastIndexOf("<")) {
                    j=inputStr.indexOf("<td>",j)+1;
                    i=inputStr.indexOf("<",j);
                    var txtElm = document.createTextNode(inputStr.substring(j+3,i));
                    var tdElm = document.createElement("td");
                    tdElm.appendChild(txtElm);
                    elm.appendChild(tdElm);
                }	
                myTable.appendChild(elm);
            }

        }
        function callback(data) {
            for (var i = 0; i < data.dps.length; i++) {
                // console.log(data.dps[i])
                dataPoints1.push({
                    x: new Date(data.dps[i].date),
                    y: data.dps[i].units
                });
            }
            chart.render();
        }




    </script>
</head>

<body>
    <div class="content">
        <div style="color:#fff; font-size: 50px; text-align: center;">Total Users</div>
        <!-- <div style="color:#fff; font-size: 50px; text-align: center">Total Conversations</div> -->
    </div>
    <div class="content">
        <div class="value" id="totalUsers" ></div>
        <!-- <div class="value" akhi="50000">0</div> -->
    </div>
    <br><br>
    <div id="visitor" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
    <br><br>
    <div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
    <br><br>
    <div id="chartSuccess" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
    <br> <br>
    <div id="sentimentChart" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
    <br> <br>
    
    <div
        style="background-color:#eee; text-align: center; width:60%;  margin-left: 25%; margin-top: 10px; margin-bottom: 125px;">
        <table id="example" class="table table-striped table-bordered">
            <caption>Top most frequently used intent</caption>

            <thead>
                    <tr>
                            <th>Intent Name</th>
                            <th>Total Occurence</th>
                    </tr>
            </thead>
            <tbody id="insertHere">
                       
            </tbody>
                
        </table>
    </div>


    <script src="./canvasjs.min.js"></script>
    <script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

</body>

</html>